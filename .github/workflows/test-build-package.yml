name: Test, Build and Package Matrix Kernel Modules

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  # Phase 1: Run comprehensive tests
  run-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-target:
          - pi4-legacy
          - pi5-latest
          - ci-standard
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Run KUnit tests for ${{ matrix.test-target }}
      run: |
        cd tests
        ./run-tests-docker.sh --verbose ${{ matrix.test-target }}

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test-target }}
        path: |
          tests/test-results-*
          tests/*.log
        retention-days: 30

  # Phase 2: Build kernel modules (only after tests pass)
  build-kernel-modules:
    needs: run-tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Pi 4 Legacy Target - 5.10.103-v7l+ ARM32
          - target: pi4-legacy
            distribution: raspbian
            codename: bullseye
            architecture: armhf
            kernel_version: "5.10.103-v7l+"
            kernel_config: "bcmrpi_defconfig"
            arch_env: "arm"
            platform: "pi4"
          # Pi 5 Latest Target - 6.12.47+rpt-rpi-2712 ARM64  
          - target: pi5-latest
            distribution: raspbian
            codename: bookworm
            architecture: arm64
            kernel_version: "6.12.47+rpt-rpi-2712"
            kernel_config: "bcm2711_defconfig"
            arch_env: "arm64"
            platform: "pi5"
          # CI Standard for compatibility testing
          - target: ci-standard
            distribution: raspbian
            codename: bookworm
            architecture: arm64
            kernel_version: "6.1.70-rpi-v8"
            kernel_config: "bcm2711_defconfig"
            arch_env: "arm64"
            platform: "ci"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t matrixio-builder .

    - name: Build kernel modules for ${{ matrix.target }}
      run: |
        echo "Building for ${{ matrix.target }}: ${{ matrix.kernel_version }} (${{ matrix.arch_env }})"
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -e ARCH=${{ matrix.arch_env }} \
          -e KERNEL_VERSION=${{ matrix.kernel_version }} \
          -e KERNEL_CONFIG=${{ matrix.kernel_config }} \
          -e TARGET_PLATFORM=${{ matrix.platform }} \
          matrixio-builder

    - name: Verify build artifacts
      run: |
        echo "=== Build artifacts ==="
        ls -la src/*.ko 2>/dev/null || echo "No .ko files found"
        ls -la src/*.dtbo 2>/dev/null || echo "No .dtbo files found"

    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.target }}-${{ matrix.architecture }}
        path: |
          src/*.ko
          src/*.dtbo
        retention-days: 30

  # Phase 3: Package (only after build succeeds)
  package:
    needs: build-kernel-modules
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Pi 4 Legacy Package - ARM32 (Raspbian Buster)
          - target: pi4-legacy
            distribution: raspbian
            codename: buster
            architecture: armhf
            platform: "pi4"
            kernel_version: "5.10.103-v7l+"
            debian_dir: "debian-buster"
            package_name: "matrixio-kernel-modules-buster"
          # Pi 5 Latest Package - ARM64 (Raspberry Pi OS Bookworm)
          - target: pi5-latest
            distribution: raspios
            codename: bookworm
            architecture: arm64
            platform: "pi5"
            kernel_version: "6.12.47+rpt-rpi-2712"
            debian_dir: "debian-bookworm"
            package_name: "matrixio-kernel-modules-bookworm"
          # CI Standard Package - ARM64 (Raspberry Pi OS Bookworm)
          - target: ci-standard
            distribution: raspios
            codename: bookworm
            architecture: arm64
            platform: "ci"
            kernel_version: "6.1.70-rpi-v8"
            debian_dir: "debian-bookworm"
            package_name: "matrixio-kernel-modules-bookworm"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ matrix.target }}-${{ matrix.architecture }}
        path: src/

    - name: Determine version
      id: version
      run: |
        # Read version from central VERSION file
        if [[ -f "VERSION" ]]; then
          VERSION=$(cat VERSION | tr -d '\n\r ')
        else
          VERSION="0.3.1"
          echo "Warning: VERSION file not found, using default version"
        fi
        
        echo "current_version=$VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$VERSION" >> $GITHUB_OUTPUT
        echo "PKG_VER=$VERSION" >> $GITHUB_ENV
        
        echo "Using global version: $VERSION"

    - name: Update debian/changelog for new version
      run: |
        # Install debchange for changelog management
        sudo apt-get update
        sudo apt-get install -y devscripts
        
        # Update changelog with new version
        export DEBEMAIL="github-actions@github.com"
        export DEBFULLNAME="GitHub Actions"
        
        # Extract commit message summary for changelog
        COMMIT_SUMMARY=$(echo "${{ github.event.head_commit.message }}" | head -1)
        
        # Update the appropriate debian directory changelog
        cd ${{ matrix.debian_dir }}
        dch -v "${{ steps.version.outputs.new_version }}-1" \
            --distribution unstable \
            "Automated version bump: $COMMIT_SUMMARY"
        cd ..

    - name: Build Debian package
      run: |
        # Install packaging dependencies
        sudo apt-get update
        sudo apt-get install -y debhelper dkms device-tree-compiler devscripts fakeroot build-essential dh-dkms
        
        # Copy appropriate debian directory to debian/ for build
        rm -rf debian
        cp -r ${{ matrix.debian_dir }} debian
        
        # Build the package (skip signing)
        debuild -us -uc -b
        
        # Move package files
        if [ -f ../${{ matrix.package_name }}_*.deb ]; then
          mv ../${{ matrix.package_name }}_*.deb .
        fi
        if [ -f ../${{ matrix.package_name }}_*.buildinfo ]; then
          mv ../${{ matrix.package_name }}_*.buildinfo . 2>/dev/null || true
        fi
        if [ -f ../${{ matrix.package_name }}_*.changes ]; then
          mv ../${{ matrix.package_name }}_*.changes . 2>/dev/null || true
        fi

    - name: Rename package for distribution
      run: |
        export COMPONENT=$([ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ] && echo "main" || echo "unstable")
        echo "COMPONENT=$COMPONENT" >> $GITHUB_ENV
        
        # Find the package file and rename it for specific target
        if ls ${{ matrix.package_name }}_*.deb 1> /dev/null 2>&1; then
          for deb_file in ${{ matrix.package_name }}_*.deb; do
            base_name=$(basename "$deb_file" .deb)
            new_name="${{ matrix.package_name }}_${{ matrix.target }}-${{ matrix.codename }}-${PKG_VER}-${COMPONENT}_${{ matrix.architecture }}.deb"
            mv "$deb_file" "$new_name"
            echo "Renamed $deb_file to $new_name"
            echo "Target: ${{ matrix.target }} (${{ matrix.kernel_version }})"
            echo "Distribution: ${{ matrix.distribution }} ${{ matrix.codename }}"
          done
        fi

    - name: Archive package artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: packages-${{ matrix.target }}-${{ matrix.architecture }}
        path: |
          *.deb
          *.buildinfo
          *.changes
        retention-days: 30

    - name: Upload release packages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ matrix.target }}-${{ matrix.architecture }}
        path: "*.deb"
        retention-days: 90


  # Phase 4: Build summary
  build-summary:
    needs: [run-tests, build-kernel-modules, package]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        merge-multiple: true

    - name: Download all package artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: packages-*
        merge-multiple: true

    - name: Build Summary Report
      run: |
        echo "## Matrix Kernel Modules CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Target | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Pi 4 Legacy (5.10.103-v7l+) | ${{ needs.run-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Pi 5 Latest (6.12.34-rpi-2712) | ${{ needs.run-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CI Standard (6.1.70-rpi-v8) | ${{ needs.run-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Build Results" >> $GITHUB_STEP_SUMMARY
        echo "| Target Platform | Kernel Version | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------------|----------------|--------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Pi 4 Legacy | 5.10.103-v7l+ | armhf | ${{ needs.build-kernel-modules.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Pi 5 Latest | 6.12.47+rpt-rpi-2712 | arm64 | ${{ needs.build-kernel-modules.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CI Standard | 6.1.70-rpi-v8 | arm64 | ${{ needs.build-kernel-modules.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Package Results" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Debian packages | ${{ needs.package.result == 'success' && '✅ Created' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Workflow Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Sequential Phases**: Tests → Build → Package" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Framework**: KUnit with Docker containers" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Management**: Semantic versioning with commit triggers" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifacts retention**: 30 days (90 days for releases)" >> $GITHUB_STEP_SUMMARY

  # Phase 5: Create GitHub Release for tags (only after all phases succeed)
  create-release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: [run-tests, build-kernel-modules, package]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download release artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: release-packages-*
        merge-multiple: true

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: "*.deb"
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        body: |
          ## Matrix Creator Kernel Modules Release
          
          This release includes kernel modules for Matrix Creator HATs with split packaging for different target systems:
          
          ### Target Systems
          - **Pi 4 Legacy**: 5.10.103-v7l+ kernel on Raspberry Pi 4 Model B Rev 1.4 (BCM2711) ARM32
          - **Pi 5 Latest**: 6.12.47+rpt-rpi-2712 kernel on Pi 5 BCM2712 ARM64
          
          ### Split Packages
          - **matrixio-kernel-modules-buster**: For Raspbian Buster (Debian 10.13) ARM32 systems
          - **matrixio-kernel-modules-bookworm**: For Raspberry Pi OS Bookworm (Debian 12.12) ARM64 systems
          
          ### Testing
          - ✅ All KUnit tests passed across kernel versions
          - ✅ Fuzzing tests completed
          - ✅ Cross-compilation verified for ARM32/ARM64
          - ✅ Kernel API compatibility layer tested
          
          ### Distribution Support
          - **Raspbian Buster** (Debian 10.13): Legacy Pi 4 systems
          - **Raspberry Pi OS Bookworm** (Debian 12.12): Modern Pi 5 and updated Pi 4 systems
          
          See the [installation guide](CLAUDE.md) for deployment instructions and package selection.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}